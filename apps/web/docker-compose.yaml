version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.prod
      target: production
      args:
        # Build-time variables (these need to be set as "Build Variables" in Coolify UI)
        - RESEND_API_KEY=${RESEND_API_KEY:-re_EQsb5GpW_HkaiK9VCCYjwAYH2Jd8xP5VN}
        - NEXT_PUBLIC_CONVEX_URL=${NEXT_PUBLIC_CONVEX_URL:-https://colorful-aardvark-576.convex.cloud}
        - BASEHUB_TOKEN=${BASEHUB_TOKEN:-"bshb_pk_puctvrqlvn8s55v47kqswt021acbzvcr0k3vwfrm0vg5u1z5w4y5g5eutbnsgcgc"}
        - SMTP_HOST=${SMTP_HOST:-smtp.example.com}
        - SMTP_PORT=${SMTP_PORT:-587}
        - SMTP_SECURE=${SMTP_SECURE:-false}
        - SMTP_USER=${SMTP_USER:-your-email@cribnosh.co.uk}
        - SMTP_PASSWORD=${SMTP_PASSWORD:-your-password}
        - SMTP_PASS=${SMTP_PASS:-your-password}
        - DEFAULT_EMAILs_PROVIDER=${DEFAULT_EMAILs_PROVIDER:-smtp}
        - NEXT_PUBLIC_USE_CUSTOM_POINTER=${NEXT_PUBLIC_USE_CUSTOM_POINTER:-false}
        - NOTION_TOKEN=${NOTION_TOKEN:-ntn_H36001900014bCHIwtL24KM5tmGAW2IzmnZolV3FZoNaKH}
        - NOTION_DATABASE_ID=${NOTION_DATABASE_ID:-2240d6968a31808388bddafaefdec9b3}
        - NEXT_PUBLIC_DISABLE_TRY_IT=${NEXT_PUBLIC_DISABLE_TRY_IT:-true}
        - CONVEX_DEPLOYMENT=${CONVEX_DEPLOYMENT:-dev:colorful-aardvark-576}
        - NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL:-cribnosh.com}
        - NEXT_PUBLIC_DISABLE_DARK_MODE=${NEXT_PUBLIC_DISABLE_DARK_MODE:-true}
        - DISABLE_TRY_IT=${DISABLE_TRY_IT:-true}
        # JWT and Authentication
        - JWT_SECRET=${JWT_SECRET:-cribnosh-dev-secret}
        # Stripe Configuration
        - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
        - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
        - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
        # Agora Live Streaming
        - AGORA_APP_ID=${AGORA_APP_ID}
        - AGORA_APP_CERTIFICATE=${AGORA_APP_CERTIFICATE}
        # Emotions Engine
        - EMOTIONS_ENGINE_URL=${EMOTIONS_ENGINE_URL:-http://localhost:3000/api/emotions-engine}
        # Email Configuration
        - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL:-onboarding@cribnosh.com}
        - RESEND_AUDIENCE_ID=${RESEND_AUDIENCE_ID:-93c15e49-f327-478e-8fc7-b7846fd19a23}
        # AI Provider Keys
        - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
        - OPENAI_API_KEY=${OPENAI_API_KEY}
        - HF_TOKEN=${HF_TOKEN}
        - GEMINI_API_KEY=${GEMINI_API_KEY}
        # Admin and Monitoring
        - ADMIN_WEBHOOK_URL=${ADMIN_WEBHOOK_URL}
        # Redis Configuration
        - REDIS_TEST_URL=${REDIS_TEST_URL:-redis://localhost:6379/15}
        - REDIS_DEV_URL=${REDIS_DEV_URL:-redis://localhost:6379/1}
        # AWS Configuration
        - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
        - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
        - AWS_REGION=${AWS_REGION:-eu-west-2}
        - S3_BUCKET_NAME=${S3_BUCKET_NAME}
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # Runtime environment variables (these will be automatically detected by Coolify)
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - RESEND_API_KEY=${RESEND_API_KEY:-re_EQsb5GpW_HkaiK9VCCYjwAYH2Jd8xP5VN}
      - NEXT_PUBLIC_CONVEX_URL=${NEXT_PUBLIC_CONVEX_URL:-https://colorful-aardvark-576.convex.cloud}
      - BASEHUB_TOKEN=${BASEHUB_TOKEN}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_PASS=${SMTP_PASS}
      - DEFAULT_EMAILs_PROVIDER=${DEFAULT_EMAILs_PROVIDER}
      - NEXT_PUBLIC_USE_CUSTOM_POINTER=${NEXT_PUBLIC_USE_CUSTOM_POINTER}
      - NOTION_TOKEN=${NOTION_TOKEN}
      - NOTION_DATABASE_ID=${NOTION_DATABASE_ID}
      - NEXT_PUBLIC_DISABLE_TRY_IT=${NEXT_PUBLIC_DISABLE_TRY_IT}
      - CONVEX_DEPLOYMENT=${CONVEX_DEPLOYMENT}
      - CONVEX_DEPLOY_KEY=${CONVEX_DEPLOY_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL}
      - NEXT_PUBLIC_DISABLE_DARK_MODE=${NEXT_PUBLIC_DISABLE_DARK_MODE}
      - DISABLE_TRY_IT=${DISABLE_TRY_IT}
      - NEXT_PUBLIC_DISABLE_CERTIFIED_KITCHENS_FLOAT=${NEXT_PUBLIC_DISABLE_CERTIFIED_KITCHENS_FLOAT:-true}
      - MATTERMOST_TOKEN_NAME=${MATTERMOST_TOKEN_NAME:-Automator}
      - MATTERMOST_ID=${MATTERMOST_ID}
      - MATTERMOST_TOKEN_ACCESS=${MATTERMOST_TOKEN_ACCESS}
      - MATTERMOST_WEBHOOK_URL=${MATTERMOST_WEBHOOK_URL}
      - MATTERMOST_BOT_TOKEN=${MATTERMOST_BOT_TOKEN}
      - MATTERMOST_SERVER_URL=${MATTERMOST_SERVER_URL}
      - MATTERMOST_CHANNEL_ID=${MATTERMOST_CHANNEL_ID}
      - MATTERMOST_TEAM_ID=${MATTERMOST_TEAM_ID}
      - STAFF_PORTAL_ENABLED=${STAFF_PORTAL_ENABLED:-true}
      - STAFF_JWT_SECRET=${STAFF_JWT_SECRET}
      - NEXT_PUBLIC_MATTERMOST_URL=${NEXT_PUBLIC_MATTERMOST_URL}
      - SLACK_CHANGELOG_WEBHOOK=${SLACK_CHANGELOG_WEBHOOK:-"https://collaboration.cribnosh.com/hooks/h84jgq3ps3ye8p4bn8yubpbxsy"}
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY:-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}
      # JWT and Authentication
      - JWT_SECRET=${JWT_SECRET:-cribnosh-dev-secret}
      # Stripe Configuration
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      # Agora Live Streaming
      - AGORA_APP_ID=${AGORA_APP_ID}
      - AGORA_APP_CERTIFICATE=${AGORA_APP_CERTIFICATE}
      # Emotions Engine
      - EMOTIONS_ENGINE_URL=${EMOTIONS_ENGINE_URL:-http://localhost:3000/api/emotions-engine}
      # Email Configuration
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL:-onboarding@cribnosh.com}
      - RESEND_AUDIENCE_ID=${RESEND_AUDIENCE_ID:-93c15e49-f327-478e-8fc7-b7846fd19a23}
      # AI Provider Keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - HF_TOKEN=${HF_TOKEN}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      # Admin and Monitoring
      - ADMIN_WEBHOOK_URL=${ADMIN_WEBHOOK_URL}
      # AWS Configuration
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-eu-west-2}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - app-logs:/app/logs
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'
    labels:
      - "coolify.managed=true"

volumes:
  app-logs:
    driver: local